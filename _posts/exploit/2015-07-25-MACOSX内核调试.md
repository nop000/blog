---
layout: post
title: MACOSX 内核调试
tags: [jekyll, syntax]
categories:
- exploit
---

当准备调试的时候，才发现，找不到像样的环境搭建向导，这促使我要写作本文，希望能帮到一些像我一样的人，可以迅速搭建起环境，把时间放到关键的地方。

## 一、本文环境
* 系统：**macOS Sierra 10.12.6**  
* KDK： **Kernel_Debug_Kit_10.12.6_build_16G1036**  
* 虚拟机：**VMWare Fusion (专业版 7.1.1 (2498930))**

## 二、搭建调试环境
第一步： 安装虚拟机镜像（下载指定版本的iso系统镜像），也可以选择另外的安装方式，如下图 

![图片](/images/install_iso.png)

第二步：关闭**主机、虚拟机**的**System Integrity Protection**机制（引自KDK目录下的`ReadMe.html`）
>To allow development using the Kernel Development Kit on macOS Sierra, you will need to modify the security configuration with the following steps:
><br>
>1. Reboot to the Recovery System by restarting your Mac and hold down the Command and R keys at startup.
>2. From the Utilities menu, select “Terminal”.
>3. Type, “csrutil disable” to disable System Integrity Protection, “csrutil enable” to reenable System Integrity Protection.
>4. Restart your Mac.

---
>1. 重启OSX系统，然后按住`Command+R`进入恢复模式的系统
>2. 当看到界面之后，选择`Utilities menu`菜单中的`Terminal`
>3. 在Terminal中输入csrutil disable 关闭SIP(csrutil enable打开SIP)
>4. 重启Mac系统


第三步： 下载指定版本的`KDK`，[`下载KDM`](https://developer.apple.com/download/more/)，如下图

![图片](/images/kdk_download.jpeg)

第四步：**主机、虚拟机**，分别安装`KDK`。  
第五步：**主机、虚拟机**，从命令行进入目录**/Library/Developer/KDKs/**，进行如下命令行操作：
![图片](/images/copy_develope.png)

---
``` bash
find . -iname "*develop*"
copy ./KDK_10.12.6_16G1036.kdk/System/Library/Kernels/kernel.development /System/Library/Kernels/
```

第六步：**虚拟机上**：  
``` bash 
sudo nvram boot-args="debug=0x141 kext-dev-mode=1 kcsuffix=development pmuflags=1 -v"
sudo kextcache -invalidate /
reboot
```
<!--![图片](/images/reboot_fusion.png)-->
<img src="/images/reboot_fusion.png" width="100%" height="100%">

第七步：**主机**：  
``` bash
lldb /Library/Developer/KDKs/KDK_10.12.6_16G1036.kdk/System/Library/Kernels/kernel
kdp-remote 192.168.140.239
```
具休操作时，将`192.168.140.239`换为你自己的虚拟机ip地址，将`KDK_10.12.6_16G1036`换为自己对应的KDK版本。
<!--![图片](/images/reboot_mac.png)-->
<img src="/images/reboot_mac.png" width="100%" height="100%">
